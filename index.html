<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø³Ø¬Ù„ Ù…ØµØ±ÙˆÙØ§ØªÙŠ - Ø·Ø§Ù„Ø¨ Ø£Ù‚Ø³Ø§Ù… Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ù„Ø¹Ø±Ø§Ù‚)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e40af', /* Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ø±Ø§Ù‚ */
            secondary: '#3b82f6',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; }
    .fade-enter { opacity: 0; transform: translateY(10px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all 0.3s ease; }
    .number-ar { font-feature-settings: "tnum"; } /* Ø£Ø±Ù‚Ø§Ù… Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-blue-100">
    <div class="max-w-4xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Ø³Ø¬Ù„ Ù…ØµØ±ÙˆÙØ§ØªÙŠ</h1>
          <p class="text-gray-600 mt-1 flex items-center">
            <i class="fas fa-graduation-cap ml-2 text-blue-600"></i>
            Ø·Ø§Ù„Ø¨ Ø£Ù‚Ø³Ø§Ù… Ø¯Ø§Ø®Ù„ÙŠØ© â€” Ø§Ù„Ø¹Ø±Ø§Ù‚
          </p>
        </div>
        <div class="bg-blue-600 text-white p-3 rounded-full">
          <i class="fas fa-coins text-xl"></i>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-md p-6 border border-blue-50">
        <div class="flex items-center">
          <div class="bg-green-100 p-3 rounded-lg mr-4">
            <i class="fas fa-chart-line text-green-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</p>
            <p id="total-amount" class="text-2xl font-bold text-gray-800 number-ar">Ù  Ø¹.Ø¯</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 border border-blue-50">
        <div class="flex items-center">
          <div class="bg-blue-100 p-3 rounded-lg mr-4">
            <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="today-amount" class="text-2xl font-bold text-gray-800 number-ar">Ù  Ø¹.Ø¯</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 border border-blue-50">
        <div class="flex items-center">
          <div class="bg-purple-100 p-3 rounded-lg mr-4">
            <i class="fas fa-list text-purple-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
            <p id="expense-count" class="text-2xl font-bold text-gray-800">Ù </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-md mb-8 overflow-hidden border border-blue-100">
      <div class="flex border-b">
        <button id="tab-list" class="flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50">
          <i class="fas fa-list ml-2"></i>
          Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        </button>
        <button id="tab-chart" class="flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700">
          <i class="fas fa-chart-pie ml-2"></i>
          Ø§Ù„ØªØ­Ù„ÙŠÙ„
        </button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content" class="p-6">
        <!-- List Tab -->
        <div id="list-tab">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
            <button id="add-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-sm">
              <i class="fas fa-plus ml-2"></i>
              Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
            </button>
          </div>

          <div id="expenses-list" class="space-y-4">
            <!-- Expenses will be inserted here -->
          </div>
        </div>

        <!-- Chart Tab -->
        <div id="chart-tab" class="hidden">
          <h2 class="text-xl font-bold text-gray-800 mb-6">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
          
          <div class="mb-8">
            <h3 class="font-medium text-gray-700 mb-4 flex items-center">
              <i class="fas fa-tags ml-2 text-blue-600"></i>
              Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
            </h3>
            <div id="category-chart" class="space-y-3">
              <!-- Category bars -->
            </div>
          </div>

          <div>
            <h3 class="font-medium text-gray-700 mb-4 flex items-center">
              <i class="fas fa-calendar-week ml-2 text-blue-600"></i>
              Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)
            </h3>
            <div id="daily-chart" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
              <!-- Daily amounts -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Expense Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modal-title" class="text-xl font-bold text-gray-800">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h2>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
        </div>

        <form id="expense-form">
          <input type="hidden" id="edit-id">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ)</label>
              <div class="relative">
                <input
                  type="number"
                  id="amount"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-12"
                  placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº"
                  step="100"
                  min="0"
                  required
                />
                <span class="absolute right-3 top-2.5 text-gray-500">Ø¹.Ø¯</span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙØ¦Ø©</label>
              <select
                id="category"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="Ø·Ø¹Ø§Ù…">ğŸ½ï¸ Ø·Ø¹Ø§Ù…</option>
                <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">ğŸšŒ Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                <option value="Ø¯Ø±Ø§Ø³Ø©">ğŸ“š Ø¯Ø±Ø§Ø³Ø©</option>
                <option value="ØªØ±ÙÙŠÙ‡">ğŸ¬ ØªØ±ÙÙŠÙ‡</option>
                <option value="ØµØ­Ø©">ğŸ’Š ØµØ­Ø©</option>
                <option value="Ø£Ø®Ø±Ù‰">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØµÙ</label>
              <input
                type="text"
                id="description"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Ù…Ø§Ø°Ø§ Ø§Ø´ØªØ±ÙŠØªØŸ"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input
                  type="date"
                  id="date"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ‚Øª</label>
                <input
                  type="time"
                  id="time"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>

          <div class="mt-8 flex space-x-3 space-x-reverse">
            <button
              type="button"
              id="cancel-btn"
              class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow"
            >
              <span id="submit-text">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-12 py-6 text-center text-gray-500 text-sm border-t">
    <p>Â© Ù¢Ù Ù¢Ù¥ Ø³Ø¬Ù„ Ù…ØµØ±ÙˆÙØ§ØªÙŠ â€” Ø®Ø¯Ù…Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</p>
    <p class="mt-1">Ø§Ø¹Ø±Ù Ø£ÙŠÙ† ØªÙ†ÙÙ‚ Ø£Ù…ÙˆØ§Ù„ÙƒØŒ ÙˆØ®Ø·Ø· Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø¨Ø°ÙƒØ§Ø¡</p>
  </footer>

  <script>
    // ÙˆØ¸ÙŠÙØ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© (Ù -Ù©) ÙˆØªÙ†Ø³ÙŠÙ‚Ù‡Ø§ (Ù…Ø«Ù„: Ù¡Ù¥Ù¬Ù Ù Ù )
    function toArabicNumber(num) {
      if (typeof num !== 'number') return 'Ù ';
      // Ø£ÙˆÙ„Ø§Ù‹: ÙØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù
      let formatted = num.toLocaleString('ar-EG', { useGrouping: true });
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© Ø¥Ù„Ù‰ Ø´Ø±Ù‚ÙŠØ©
      const latinDigits = '0123456789';
      const easternDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      return formatted.replace(/\d/g, d => easternDigits[latinDigits.indexOf(d)]) + ' Ø¹.Ø¯';
    }

    // Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    const categories = {
      'Ø·Ø¹Ø§Ù…': { icon: 'ğŸ½ï¸', color: 'bg-red-100 text-red-800' },
      'Ù…ÙˆØ§ØµÙ„Ø§Øª': { icon: 'ğŸšŒ', color: 'bg-blue-100 text-blue-800' },
      'Ø¯Ø±Ø§Ø³Ø©': { icon: 'ğŸ“š', color: 'bg-green-100 text-green-800' },
      'ØªØ±ÙÙŠÙ‡': { icon: 'ğŸ¬', color: 'bg-purple-100 text-purple-800' },
      'ØµØ­Ø©': { icon: 'ğŸ’Š', color: 'bg-pink-100 text-pink-800' },
      'Ø£Ø®Ø±Ù‰': { icon: 'ğŸ“¦', color: 'bg-gray-100 text-gray-800' }
    };

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let expenses = [];
    let activeTab = 'list';
    let editingId = null;

    // Ø¹Ù†Ø§ØµØ± DOM
    const els = {
      totalAmount: document.getElementById('total-amount'),
      todayAmount: document.getElementById('today-amount'),
      expenseCount: document.getElementById('expense-count'),
      expensesList: document.getElementById('expenses-list'),
      categoryChart: document.getElementById('category-chart'),
      dailyChart: document.getElementById('daily-chart'),
      modal: document.getElementById('modal'),
      expenseForm: document.getElementById('expense-form'),
      modalTitle: document.getElementById('modal-title'),
      submitText: document.getElementById('submit-text'),
      editId: document.getElementById('edit-id'),
      amount: document.getElementById('amount'),
      category: document.getElementById('category'),
      description: document.getElementById('description'),
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      tabList: document.getElementById('tab-list'),
      tabChart: document.getElementById('tab-chart'),
      listTab: document.getElementById('list-tab'),
      chartTab: document.getElementById('chart-tab'),
      addBtn: document.getElementById('add-btn'),
      closeModal: document.getElementById('close-modal'),
      cancelBtn: document.getElementById('cancel-btn')
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
    const now = new Date();
    const todayISO = now.toISOString().split('T')[0];
    const currentTime = now.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' });

    els.date.value = todayISO;
    els.time.value = currentTime;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† localStorage Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹ÙŠÙ†Ø©
    function loadExpenses() {
      const saved = localStorage.getItem('iraqi_student_expenses');
      if (saved) {
        try {
          expenses = JSON.parse(saved);
          // ØªØ£ÙƒØ¯ Ø£Ù† ÙƒÙ„ Ù…ØµØ±ÙˆÙ Ù„Ù‡ id
          expenses.forEach((exp, i) => {
            if (exp.id === undefined) exp.id = Date.now() + i;
          });
        } catch (e) {
          expenses = [];
        }
      }
      
      if (expenses.length === 0) {
        // Ø¹ÙŠÙ†Ø© Ø£ÙˆÙ„ÙŠØ© (Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
        expenses = [
          { id: 1, amount: 15000, category: 'Ø·Ø¹Ø§Ù…', description: 'ØºØ¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ', date: '2025-11-18', time: '13:30' },
          { id: 2, amount: 5000, category: 'Ù…ÙˆØ§ØµÙ„Ø§Øª', description: 'ØªØ°ÙƒØ±Ø© Ø¨Ø§Øµ Ø°Ù‡Ø§Ø¨ ÙˆØ¥ÙŠØ§Ø¨', date: '2025-11-18', time: '08:15' },
          { id: 3, amount: 20000, category: 'Ø¯Ø±Ø§Ø³Ø©', description: 'Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆØ±Ø§Ù‚ Ø¨Ø­Ø«', date: '2025-11-19', time: '10:45' },
          { id: 4, amount: 8000, category: 'Ø·Ø¹Ø§Ù…', description: 'Ø¹Ø´Ø§Ø¡ Ø®ÙÙŠÙ', date: '2025-11-19', time: '20:00' },
          { id: 5, amount: 10000, category: 'ØªØ±ÙÙŠÙ‡', description: 'ÙÙŠÙ„Ù… Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡', date: '2025-11-20', time: '19:00' },
        ];
        saveExpenses(); // Ø§Ø­ÙØ¸ Ø§Ù„Ø¹ÙŠÙ†Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©
      }
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ localStorage
    function saveExpenses() {
      try {
        localStorage.setItem('iraqi_student_expenses', JSON.stringify(expenses));
      } catch (e) {
        console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', e);
        alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† localStorage Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡.');
      }
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶
    function renderStats() {
      const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      const today = expenses
        .filter(exp => exp.date === todayISO)
        .reduce((sum, exp) => sum + exp.amount, 0);
      
      els.totalAmount.textContent = toArabicNumber(total);
      els.todayAmount.textContent = toArabicNumber(today);
      els.expenseCount.textContent = toArabicNumber(expenses.length).replace(/ Ø¹\.Ø¯$/, '');
    }

    function renderExpensesList() {
      if (expenses.length === 0) {
        els.expensesList.innerHTML = `
          <div class="text-center py-12">
            <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-coins text-gray-400 text-xl"></i>
            </div>
            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù‘Ù„Ø© Ø¨Ø¹Ø¯</p>
            <button id="add-first-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
              <i class="fas fa-plus ml-2"></i> Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…ØµØ±ÙˆÙ
            </button>
          </div>
        `;
        document.getElementById('add-first-btn')?.addEventListener('click', () => {
          els.addBtn.click();
        });
        return;
      }

      els.expensesList.innerHTML = expenses.map(exp => {
        const cat = categories[exp.category] || { icon: 'ğŸ“¦', color: 'bg-gray-100 text-gray-800' };
        const dateObj = new Date(exp.date);
        const formattedDate = dateObj.toLocaleDateString('ar-EG');
        
        return `
          <div class="border rounded-lg p-4 hover:shadow-md transition-shadow fade-enter fade-enter-active bg-white">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-medium text-gray-800">${exp.description}</h3>
                <div class="flex items-center mt-1 text-sm text-gray-500">
                  <i class="fas fa-clock ml-1"></i>
                  ${exp.time}
                  <span class="mx-2">â€¢</span>
                  <i class="fas fa-calendar ml-1"></i>
                  ${formattedDate}
                </div>
              </div>
              <div class="text-left mr-4">
                <p class="text-xl font-bold text-gray-800 number-ar">${toArabicNumber(exp.amount).replace(' Ø¹.Ø¯', '')}</p>
                <span class="inline-block px-3 py-1 rounded-full text-xs mt-1 ${cat.color}">
                  ${cat.icon} ${exp.category}
                </span>
              </div>
              <div class="flex flex-col space-y-1">
                <button onclick="editExpense(${exp.id})" 
                  class="p-2 text-blue-600 hover:bg-blue-50 rounded-full" title="ØªØ¹Ø¯ÙŠÙ„">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteExpense(${exp.id})" 
                  class="p-2 text-red-600 hover:bg-red-50 rounded-full" title="Ø­Ø°Ù">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCategoryChart() {
      const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      if (total === 0) {
        els.categoryChart.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>';
        return;
      }

      const categoryTotals = expenses.reduce((acc, exp) => {
        acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
        return acc;
      }, {});

      els.categoryChart.innerHTML = Object.entries(categoryTotals).map(([category, totalCat]) => {
        const percentage = (totalCat / total) * 100;
        const cat = categories[category] || { icon: 'ğŸ“¦', color: 'bg-gray-100 text-gray-800' };

        return `
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full flex items-center justify-center ${cat.color} mr-3">
              <span>${cat.icon}</span>
            </div>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="font-medium">${category}</span>
                <span class="font-medium number-ar">${toArabicNumber(totalCat).replace(' Ø¹.Ø¯', '')}</span>
              </div>
              <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 rounded-full" style="width: ${percentage}%; transition: width 0.8s ease-out;"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDailyChart() {
      const dailyTotals = expenses.reduce((acc, exp) => {
        acc[exp.date] = (acc[exp.date] || 0) + exp.amount;
        return acc;
      }, {});

      const sortedDates = Object.keys(dailyTotals).sort().reverse().slice(0, 7);
      
      if (sortedDates.length === 0) {
        els.dailyChart.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>';
        return;
      }

      els.dailyChart.innerHTML = sortedDates.map(date => {
        const dateObj = new Date(date);
        const dayName = dateObj.toLocaleDateString('ar-EG', { weekday: 'short' });
        const dayNum = dateObj.getDate();
        
        return `
          <div class="bg-gray-50 rounded-lg p-3 text-center border border-blue-50">
            <p class="text-xs text-gray-600 mb-1 font-medium">${dayName} <span class="text-blue-600">${dayNum}</span></p>
            <p class="text-lg font-bold text-gray-800 number-ar">${toArabicNumber(dailyTotals[date]).replace(' Ø¹.Ø¯', '')}</p>
            <span class="text-xs text-blue-600">Ø¹.Ø¯</span>
          </div>
        `;
      }).join('');
    }

    function renderAll() {
      renderStats();
      if (activeTab === 'list') {
        renderExpensesList();
      } else {
        renderCategoryChart();
        renderDailyChart();
      }
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„
    function deleteExpense(id) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
        expenses = expenses.filter(exp => exp.id !== id);
        saveExpenses();
        renderAll();
      }
    }

    function editExpense(id) {
      const exp = expenses.find(e => e.id === id);
      if (!exp) return;

      editingId = id;
      els.modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ';
      els.submitText.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ';
      els.editId.value = id;
      els.amount.value = exp.amount;
      els.category.value = exp.category;
      els.description.value = exp.description;
      els.date.value = exp.date;
      els.time.value = exp.time;

      els.modal.classList.remove('hidden');
    }

    // Ø£Ø­Ø¯Ø§Ø«
    els.addBtn.addEventListener('click', () => {
      editingId = null;
      els.modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯';
      els.submitText.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
      els.editId.value = '';
      els.amount.value = '';
      els.category.value = 'Ø·Ø¹Ø§Ù…';
      els.description.value = '';
      els.date.value = todayISO;
      els.time.value = currentTime;

      els.modal.classList.remove('hidden');
    });

    els.closeModal.addEventListener('click', () => {
      els.modal.classList.add('hidden');
    });

    els.cancelBtn.addEventListener('click', () => {
      els.modal.classList.add('hidden');
    });

    els.expenseForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const amount = parseInt(els.amount.value) || 0;
      const category = els.category.value;
      const description = els.description.value.trim() || 'Ù…ØµØ§Ø±ÙŠÙ Ø¹Ø§Ù…Ø©';
      const date = els.date.value;
      const time = els.time.value;

      if (amount <= 0) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ (Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±)');
        return;
      }

      if (editingId) {
        // ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬ÙˆØ¯
        const index = expenses.findIndex(exp => exp.id === editingId);
        if (index !== -1) {
          expenses[index] = { id: editingId, amount, category, description, date, time };
        }
      } else {
        // Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯
        const newExpense = {
          id: Date.now(),
          amount,
          category,
          description,
          date,
          time
        };
        expenses.unshift(newExpense);
      }

      saveExpenses();
      renderAll();
      els.modal.classList.add('hidden');
    });

    els.tabList.addEventListener('click', () => {
      activeTab = 'list';
      els.tabList.className = 'flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50';
      els.tabChart.className = 'flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700';
      els.listTab.classList.remove('hidden');
      els.chartTab.classList.add('hidden');
      renderExpensesList();
    });

    els.tabChart.addEventListener('click', () => {
      activeTab = 'chart';
      els.tabChart.className = 'flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50';
      els.tabList.className = 'flex-1 flex items-center justify-center py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700';
      els.listTab.classList.add('hidden');
      els.chartTab.classList.remove('hidden');
      renderCategoryChart();
      renderDailyChart();
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadExpenses();
    renderAll();
  </script>
</body>
</html>

